name: Devops Fertalizer Front

on:
  push:
    branches:
      - stage
      - develop
    tags:
      - "v*"
  pull_request:
    branches:
      - main

permissions:
  contents: read

env:
  REACT_APP_GROQ_API: ${{ secrets.REACT_APP_GROQ_API }}

jobs:

# ------- START FRONT PROCCESS -------- #

  

    

  TestFront:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install packages
        run: npm --prefix ./src install
      - name: Run tests
        run: npm --prefix ./src test

# ------- END FRONT PROCCESS -------- #

# ------- START MERGE PROCCESS -------- #

  MergeMasterApi:
    needs: [TestFront]
    if: github.event_name == 'push'
    name: Merge Pre deploy with Main
    permissions: 
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN || secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge to all branches
        run: |
          SOURCE_BRANCH="${{ github.ref_name }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          # Function to merge to a branch
          merge_to_branch() {
            local TARGET_BRANCH=$1
            if [ "$SOURCE_BRANCH" != "$TARGET_BRANCH" ]; then
              echo "Merging $SOURCE_BRANCH into $TARGET_BRANCH..."
              git checkout $TARGET_BRANCH
              git pull origin $TARGET_BRANCH
              git merge origin/$SOURCE_BRANCH --no-edit -m "Merge $SOURCE_BRANCH into $TARGET_BRANCH: $COMMIT_MSG"
              git push origin $TARGET_BRANCH
            else
              echo "Skipping merge to $TARGET_BRANCH (same as source branch)"
            fi
          }
          
          # Merge to develop
          merge_to_branch develop
          
          # Merge to main
          merge_to_branch main
          
          # Merge to stage
          merge_to_branch stage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || secrets.PAT_TOKEN }}

# ------- END MERGE PROCCESS -------- #

# ------- START RELEASE PROCCESS -------- #

  PostRelease:
    needs: MergeMasterApi
    if: github.event_name == 'push'
    name: Create Release
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: '0'
    - uses: actions/setup-node@v3
      with:
          node-version: 18
    # Front Zip
    - name: Install packages
      run: |
          cd ./src
          echo "REACT_APP_GROQ_API=${{env.REACT_APP_GROQ_API}}" > .env
          npm install

    - name: Run build
      run: npm --prefix ./src run build

    - name: Zip artifact front for deployment
      run: |
          cd ./src/build
          ls
          zip releaseFront.zip ./* -r
    # Upload Artifacts
    - name: Upload Front artifact for deployment job
      uses: actions/upload-artifact@v4
      with:
        name: Frontend
        path: ./src/build/releaseFront.zip
    # Generate Tagname
    - name: Generate Tagname for release
      id: taggerDryRun
      uses: anothrNick/github-tag-action@1.61.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        DRY_RUN: true
        DEFAULT_BUMP: patch
        RELEASE_BRANCHES : stage,main
        BRANCH_HISTORY: last
    # Create release
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        tag_name: ${{ steps.taggerDryRun.outputs.new_tag }}
        release_name: Release ${{ steps.taggerDryRun.outputs.new_tag }}
        #body_path: ./body.md
        body: ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false
    # Upload Assets to release
    - name: Upload Release Asset Front
      id: upload-front-release-asset 
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./src/build/releaseFront.zip
        asset_name: releaseFront.zip
        asset_content_type: application/zip

# ------- END RELEASE PROCCESS -------- #
      
